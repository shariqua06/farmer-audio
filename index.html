<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Farmer Subsidy Application</title>
<link href="https://fonts.googleapis.com/css2?family=Material+Icons&family=Inter:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ---------- Layout & visuals ---------- */
:root{--accent:#4f46e5;--accent2:#48bee5;--green:#16a34a}
*{box-sizing:border-box}
body{font-family:Inter,Arial,sans-serif;background:linear-gradient(135deg,#f7ffe0,#e0e7ff);min-height:100vh;margin:0;display:flex;align-items:center;justify-content:center;color:#1e2539}
.container{background:#fff;border-radius:18px;padding:28px;width:100%;max-width:620px;box-shadow:0 18px 60px rgba(30,40,80,0.08)}
h2{color:var(--accent);text-align:center;margin:0 0 6px;font-size:1.35rem}
.subtitle{color:#6b7280;text-align:center;margin:0 0 18px}
#progressBar{height:8px;background:#eef2ff;border-radius:8px;overflow:hidden;margin:8px 0 18px}
#progressBar span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#7a88ff,#48bee5);transition:width .35s}
.field-row{display:flex;gap:10px;align-items:flex-start;margin-bottom:12px}
.field-label{display:flex;gap:10px;align-items:center;font-weight:600}
input,select{width:100%;padding:12px 14px;border-radius:10px;border:2px solid #e6eaf8;background:#fbfeff;font-size:1rem;transition:box-shadow .18s,border-color .18s}
input:focus,select:focus{outline:none;border-color:#7a88ff;box-shadow:0 10px 30px rgba(120,130,255,0.06)}
.icon{font-family:'Material Icons';font-size:20px;color:var(--accent2)}
.voice-btn{width:52px;height:52px;border-radius:50%;border:none;background:#ebe6ff;color:var(--accent);cursor:pointer;font-size:22px;display:flex;align-items:center;justify-content:center;position:relative}
.voice-btn.recording::after{content:"";position:absolute;right:8px;top:8px;width:12px;height:12px;border-radius:50%;background:#ff5252;box-shadow:0 0 8px #ff5252;animation:ping 1s infinite}
@keyframes ping{0%{transform:scale(.85);opacity:.6}50%{transform:scale(1);opacity:1}100%{transform:scale(.85);opacity:.6}}
.voice-btn:disabled{opacity:.45;cursor:not-allowed}
.numeric-keypad{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.numeric-keypad button{flex:1 0 22%;padding:10px;border-radius:8px;border:1px solid #e6eaf8;background:#f7f8ff;font-weight:700;cursor:pointer}
#video{width:100%;min-height:120px;border-radius:12px;border:2px solid #e6eaf8;background:#f4f6ff;object-fit:cover;margin-top:10px}
.hint{font-size:.93rem;color:#6b7280;margin-top:8px;display:flex;gap:8px;align-items:center}
.submit-btn{width:100%;padding:12px;border-radius:12px;border:none;background:var(--accent);color:#fff;font-weight:700;margin-top:16px;cursor:pointer;font-size:1rem}
#listeningMic{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:118px;height:118px;border-radius:999px;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:48px;box-shadow:0 30px 80px rgba(79,70,229,0.18);z-index:9999}
#successTick{display:none;position:fixed;left:50%;top:38%;transform:translate(-50%,-50%) scale(0);font-size:110px;color:var(--green);z-index:9999}
.check-bubble{position:fixed;right:32px;bottom:32px;background:var(--green);color:#fff;width:64px;height:64px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 18px 50px rgba(16,185,129,0.16);opacity:0;transform:translateY(20px);transition:all .45s;z-index:9998}
.check-bubble.show{opacity:1;transform:translateY(0);}

/* bounce animation for final tick (style 2) */
@keyframes popIn {
  0%{transform:translate(-50%,-50%) scale(0);}
  60%{transform:translate(-50%,-50%) scale(1.15);}
  100%{transform:translate(-50%,-50%) scale(1);}
}

/* small responsive */
@media(max-width:520px){.container{padding:16px;border-radius:12px}#video{min-height:90px}}
</style>
</head>
<body>
<div class="container" id="app">
  <h2>Farmer Subsidy Application</h2>
  <div class="subtitle">Tamil prompt → English prompt → Speak. OCR & keypads included.</div>

  <div id="progressBar"><span></span></div>

  <form id="form" autocomplete="off">
    <!-- NAME -->
    <div class="field-row">
      <div style="flex:1">
        <label class="field-label"><span class="icon">person</span><span>Name</span></label>
        <input id="name" placeholder="Enter name" />
      </div>
      <button type="button" class="voice-btn" id="voiceName"><span class="icon">mic</span></button>
    </div>

    <!-- LOCATION -->
    <div class="field-row">
      <div style="flex:1">
        <label class="field-label"><span class="icon">location_on</span><span>Farm Location</span></label>
        <input id="location" placeholder="Enter farm location" />
      </div>
      <button type="button" class="voice-btn" id="voiceLocation"><span class="icon">mic</span></button>
    </div>

    <!-- SUBSIDY -->
    <div class="field-row">
      <div style="flex:1">
        <label class="field-label"><span class="icon">agriculture</span><span>Subsidy Type</span></label>
        <select id="subsidyType">
          <option value="">-- Select Subsidy --</option>
          <option value="urimam">Urimam</option>
          <option value="parivu">Parivu</option>
          <option value="vidhai">Vidhai</option>
          <option value="ubagaranam">Ubagaranam</option>
        </select>
      </div>
      <button type="button" class="voice-btn" id="voiceSubsidy"><span class="icon">mic</span></button>
    </div>

    <!-- AMOUNT -->
    <div class="field-row">
      <div style="flex:1">
        <label class="field-label"><span class="icon">payments</span><span>Amount</span></label>
        <input id="amount" placeholder="Enter amount" inputmode="numeric" />
        <div class="numeric-keypad" id="amountKeypad"></div>
      </div>
      <button type="button" class="voice-btn" id="voiceAmount"><span class="icon">mic</span></button>
    </div>

    <!-- AADHAAR (voice + OCR + keypad) -->
    <div class="field-row">
      <div style="flex:1">
        <label class="field-label"><span class="icon">credit_card</span><span>Aadhaar Number</span></label>
        <input id="aadhaarNumber" placeholder="Auto or speak Aadhaar" readonly />
        <div class="numeric-keypad" id="aadhaarKeypad"></div>
      </div>
      <button type="button" class="voice-btn" id="voiceAadhaar"><span class="icon">mic</span></button>
    </div>

    <video id="video" autoplay muted playsinline></video>
    <div class="hint"><span class="icon">fact_check</span>Hold Aadhaar card steady in front of camera to auto-fill (OCR).</div>

    <button class="submit-btn" type="submit">Submit Form</button>
  </form>
</div>

<!-- mic indicator + final tick -->
<div id="listeningMic">🎤</div>
<div id="successTick">✔</div>
<div class="check-bubble" id="checkBubble">✔</div>

<!-- Tesseract -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.4.0/dist/tesseract.min.js"></script>

<script>
/* ---------------- CONFIG - repo & audio filenames ----------------
   uses your GitHub: https://github.com/shariqua06/farmer-audio (main branch)
------------------------------------------------------------------ */
const GITHUB_RAW_BASE = 'https://raw.githubusercontent.com/shariqua06/farmer-audio/main/';
const tamilAudios = {
  name: GITHUB_RAW_BASE + 'name.mp3',
  location: GITHUB_RAW_BASE + 'farmlocation.mp3',
  subsidyType: GITHUB_RAW_BASE + 'type.mp3',
  amount: GITHUB_RAW_BASE + 'amount.mp3',
  aadhaar: GITHUB_RAW_BASE + 'aadhar.mp3'
};

/* ---------------- DOM refs ---------------- */
const listeningMic = document.getElementById('listeningMic');
const successTick = document.getElementById('successTick');
const checkBubble = document.getElementById('checkBubble');
const progressBar = document.querySelector('#progressBar span');
const videoEl = document.getElementById('video');
const aadhaarInput = document.getElementById('aadhaarNumber');

/* ---------------- progress ---------------- */
function setProgress(p){ progressBar.style.width = p + '%'; }
['name','location','subsidyType','amount','aadhaarNumber'].forEach((id,i)=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('focus', ()=> setProgress((i+1)*20));
});

/* ---------------- Tesseract OCR (init + safe loop) ---------------- */
let tessWorker = null;
let ocrReady = false;

async function initTesseract(){
  try{
    tessWorker = Tesseract.createWorker({ logger: m => {/* optionally console.log(m) */} });
    await tessWorker.load();
    await tessWorker.loadLanguage('eng');
    await tessWorker.initialize('eng');
    ocrReady = true;
    console.log('Tesseract ready');
  }catch(e){
    console.error('Tesseract init error', e);
    ocrReady = false;
  }
}
initTesseract();

/* ---------------- camera ---------------- */
async function startCamera(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    videoEl.srcObject = s;
    await videoEl.play();
  }catch(err){
    console.warn('Camera start error:', err);
  }
}
startCamera();

/* ---------------- OCR scan loop (only runs when ocrReady) ---------------- */
const scanCanvas = document.createElement('canvas');
const scanCtx = scanCanvas.getContext('2d');

async function scanLoop(){
  try{
    if(videoEl.readyState >= 2 && ocrReady && tessWorker){
      scanCanvas.width = videoEl.videoWidth || 640;
      scanCanvas.height = videoEl.videoHeight || 480;
      scanCtx.drawImage(videoEl, 0, 0, scanCanvas.width, scanCanvas.height);

      try{
        const res = await tessWorker.recognize(scanCanvas);
        const text = res?.data?.text || '';
        const m = text.match(/\b\d{4}\s*\d{4}\s*\d{4}\b/);
        if(m){
          const digits = m[0].replace(/\s/g,'');
          if(digits.length === 12 && !aadhaarInput.value){
            aadhaarInput.value = digits;
            showFieldCompleteVisual('aadhaarNumber');
            checkFormComplete();
          }
        }
      }catch(e){
        // ignore intermittent OCR read errors
      }
    }
  }catch(e){
    console.warn('scanLoop error', e);
  } finally {
    requestAnimationFrame(scanLoop);
  }
}
scanLoop(); // loop checks ocrReady internally

/* ---------------- Keypads ---------------- */
function buildKeypad(containerId, inputEl, maxDigits=12){
  const container = document.getElementById(containerId);
  if(!container) return;
  container.innerHTML = '';
  const keys = [1,2,3,4,5,6,7,8,9,'←',0,'CLR'];
  keys.forEach(k=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = k;
    btn.onclick = ()=>{
      if(k === 'CLR'){ inputEl.value = ''; return; }
      if(k === '←'){ inputEl.value = inputEl.value.slice(0,-1); return; }
      if((inputEl.value.replace(/\D/g,'')).length >= maxDigits) return;
      inputEl.value = (inputEl.value + k).replace(/\D/g,'');
      showFieldCompleteVisual(inputEl.id);
      checkFormComplete();
    };
    container.appendChild(btn);
  });
}
buildKeypad('amountKeypad', document.getElementById('amount'), 10);
buildKeypad('aadhaarKeypad', aadhaarInput, 12);

/* ---------------- audio helper with fallback ---------------- */
function makeAudio(url){
  const a = new Audio();
  a.crossOrigin = 'anonymous';
  a.preload = 'auto';
  a.src = url;
  a.addEventListener('error', (e)=>{
    console.error('Audio failed to load:', url, e);
    // gentle user hint (only once)
    if(!window.__audioAlertShown){
      window.__audioAlertShown = true;
      alert('Unable to load Tamil audio from GitHub. Please check repo/filenames. (URLs used in the code assume repo: shariqua06/farmer-audio, branch main.)');
    }
  });
  return a;
}

/* ---------------- mic control helpers ---------------- */
function disableOtherMics(activeBtn){
  document.querySelectorAll('.voice-btn').forEach(b=>{ if(b !== activeBtn) b.disabled = true; });
}
function enableAllMics(){ document.querySelectorAll('.voice-btn').forEach(b=> b.disabled = false); }

function showFieldCompleteVisual(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.boxShadow = '0 10px 30px rgba(22,163,74,0.12)';
  el.style.borderColor = '#16a34a';
  setTimeout(()=>{ el.style.boxShadow=''; el.style.borderColor=''; },1400);
}

/* ---------------- final success animation (bounce) ---------------- */
function showFinalSuccess(){
  successTick.style.display = 'block';
  successTick.style.animation = 'none';
  // force reflow then animate
  void successTick.offsetWidth;
  successTick.style.animation = 'popIn .45s ease-out forwards';
  // small bottom-right bubble
  checkBubble.classList.add('show');
  setTimeout(()=>{ checkBubble.classList.remove('show'); }, 2600);
  setTimeout(()=>{ successTick.style.display = 'none'; }, 2400);
}

/* ---------------- core flow: Tamil audio -> English TTS -> Recognition ---------------- */
function playTamilThenTTSThenListen(field, opts = {}){
  // field: 'name','location','subsidyType','amount','aadhaar'
  const targetId = opts.targetId || (field === 'aadhaar' ? 'aadhaarNumber' : field);
  const btn = document.getElementById('voice' + (targetId.charAt(0).toUpperCase() + targetId.slice(1)));
  btn.disabled = true;
  btn.classList.add('recording');
  disableOtherMics(btn);

  const tamilUrl = tamilAudios[field];
  const audio = makeAudio(tamilUrl);

  // attempt to play Tamil audio; if fails, still proceed to TTS
  audio.play().catch(err=>{
    console.warn('audio.play() failed, proceeding with TTS', err);
    proceedWithTTS();
  });

  audio.onended = proceedWithTTS;
  audio.onerror = proceedWithTTS;

  function proceedWithTTS(){
    const prompts = {
      name: 'Please say your name now.',
      location: 'Please say your farm location now.',
      subsidyType: 'Please say the subsidy type now.',
      amount: 'Please say the amount now.',
      aadhaar: 'Please speak your twelve digit Aadhaar number slowly now.'
    };
    const utt = new SpeechSynthesisUtterance(prompts[field] || 'Please speak now.');
    utt.lang = 'en-IN';
    utt.onend = startRecognition;
    speechSynthesis.cancel();
    speechSynthesis.speak(utt);
  }

  function startRecognition(){
    listeningMic.style.display = 'flex';
    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!Recognition){
      alert('Speech Recognition not supported in this browser. Use Chrome for best results.');
      cleanup();
      return;
    }
    const rec = new Recognition();
    rec.lang = 'en-IN';
    rec.interimResults = false;
    rec.maxAlternatives = 1;

    rec.onresult = (ev) => {
      let text = ev.results[0][0].transcript.trim();
      if(opts.mapValues){
        const low = text.toLowerCase();
        if(opts.mapValues[low]) text = opts.mapValues[low];
      }

      if(field === 'aadhaar'){
        const digits = text.replace(/\D/g,'').slice(0,12);
        document.getElementById(targetId).value = digits;
      } else if(targetId === 'subsidyType'){
        const sel = document.getElementById('subsidyType');
        const low = text.toLowerCase();
        let matched = false;
        for(const o of sel.options){
          if(o.value && (o.value.toLowerCase() === low || o.text.toLowerCase() === low)){
            sel.value = o.value; matched = true; break;
          }
        }
        if(!matched) sel.value = text;
      } else {
        document.getElementById(targetId).value = text;
      }

      showFieldCompleteVisual(targetId);
      cleanup();
      checkFormComplete();
    };

    rec.onerror = (e) => {
      console.warn('Recognition error', e);
      cleanup();
    };

    rec.onend = () => {
      // cleanup will already run, but ensure buttons re-enabled
      cleanup();
    };

    try{ rec.start(); } catch(e) { console.warn('rec.start error', e); cleanup(); }

    function cleanup(){
      listeningMic.style.display = 'none';
      btn.disabled = false;
      btn.classList.remove('recording');
      enableAllMics();
    }
  }
}

/* ---------------- wire buttons ---------------- */
document.getElementById('voiceName').onclick = ()=> playTamilThenTTSThenListen('name');
document.getElementById('voiceLocation').onclick = ()=> playTamilThenTTSThenListen('location');
document.getElementById('voiceSubsidy').onclick = ()=> playTamilThenTTSThenListen('subsidyType', {
  mapValues: { 'urimam':'urimam','parivu':'parivu','vidhai':'vidhai','ubagaranam':'ubagaranam' }
});
document.getElementById('voiceAmount').onclick = ()=> playTamilThenTTSThenListen('amount');
document.getElementById('voiceAadhaar').onclick = ()=> playTamilThenTTSThenListen('aadhaar');

/* ---------------- check completion ---------------- */
function checkFormComplete(){
  const allFilled = ['name','location','subsidyType','amount','aadhaarNumber'].every(id=>{
    const v = document.getElementById(id).value;
    return v !== null && String(v).trim().length > 0;
  });
  if(allFilled) showFinalSuccess();
}

/* ---------------- form submit ---------------- */
document.getElementById('form').onsubmit = (e) => {
  e.preventDefault();
  const missing = ['name','location','subsidyType','amount','aadhaarNumber'].filter(id=> !document.getElementById(id).value);
  if(missing.length){
    alert('Please complete all fields first.');
    missing.forEach(id=>{
      const el = document.getElementById(id);
      el.style.borderColor = '#ee2b2b';
      setTimeout(()=> el.style.borderColor = '', 1400);
    });
    return;
  }
  alert('Form submitted!\nName: ' + document.getElementById('name').value +
        '\nLocation: ' + document.getElementById('location').value +
        '\nSubsidy: ' + document.getElementById('subsidyType').value +
        '\nAmount: ' + document.getElementById('amount').value +
        '\nAadhaar: ' + document.getElementById('aadhaarNumber').value);
  document.getElementById('form').reset();
  setProgress(0);
};

/* ---------------- progress update on input ---------------- */
['name','location','subsidyType','amount','aadhaarNumber'].forEach((id)=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', ()=>{
    const filled = ['name','location','subsidyType','amount','aadhaarNumber'].filter(x=>document.getElementById(x).value).length;
    setProgress(Math.round((filled/5)*100));
  });
});

/* ---------------- final notes ---------------- */
window.addEventListener('load', ()=> {
  console.log('Ready. Using audio URLs from: ' + GITHUB_RAW_BASE);
});
</script>
</body>
</html>
