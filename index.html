<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Farmer Subsidy Application – AI Form Filler</title>
<link href="https://fonts.googleapis.com/css2?family=Material+Icons&family=Inter:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
    font-family:'Inter',Arial,sans-serif;
    background: linear-gradient(135deg,#f4e5ff 0%,#e0d4ff 100%);
    color:#1e2539;
    min-height:100vh;
    margin:0;
    display:flex;
    align-items:center;
    justify-content:center;
}
.container {
    background:#fff;
    border-radius:20px;
    width:100%;
    max-width:520px;
    padding:28px 14px 38px 14px;
    box-shadow:0 8px 32px rgba(112,144,176,0.18);
    transition: all 0.4s ease-in-out;
}
h2 {
    text-align:center;
    color:#7e57c2;
    margin-bottom:.35em;
    letter-spacing:1.2px;
}
.subtitle {
    text-align:center;
    color:#888da8;
    font-size:1rem;
    margin:0 0 16px 0;
}
#progressBar {
    width:100%;
    height:7px;
    background:#f1f5f9;
    border-radius:8px;
    margin:12px 0 20px;
    overflow:hidden;
}
#progressBar span {
    display:block;
    height:100%;
    background:linear-gradient(90deg,#ab47bc,#ba68c8);
    width:0%;
    transition:width .4s;
}
.field-label {
    font-weight:600;
    font-size:1.03em;
    margin-bottom:4px;
    display:flex;
    align-items:center;
    gap:7px;
}
input,select {
    width:100%;
    border:2px solid #e3e7f4;
    background:#fafdff;
    font-size:1em;
    border-radius:11px;
    padding:12px 14px;
    margin-bottom:10px;
    transition:border .2s;
}
input:focus,select:focus {
    border-color:#ab47bc;
    outline:none;
    background:#f6fafd;
    box-shadow:0 2px 8px rgba(120,130,255,0.12);
}
.field-row {
    display:flex;
    gap:7px;
    margin-bottom:8px;
    align-items:flex-start;
}
.icon {
    font-family:'Material Icons';
    font-weight:normal;
    font-style:normal;
    font-size:1.35em;
    color:#ba68c8;
    vertical-align:bottom;
}
.voice-btn {
    background:#ebe6ff;
    color:#523ae8;
    border-radius:50%;
    padding:.5em;
    width:50px;
    height:50px;
    border:none;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    font-size:28px;
    margin-left:7px;
    position:relative;
    transition:all .3s ease;
}
.voice-btn.glow {
    box-shadow: 0 0 12px #ab47bc;
}
.voice-btn:disabled {
    opacity:.5;
    cursor:not-allowed;
}
#video {
    width:100%;
    border-radius:14px;
    margin-top:10px;
    margin-bottom:6px;
    background:#eee;
    min-height:135px;
    object-fit:cover;
    border:2px solid #e0e7ff;
}
#aadhaarNumber[readonly] {
    font-weight:600;
    background:#f4f8ff;
}
.submit-btn {
    width:100%;
    padding:13px;
    color:#fff;
    background:#7e57c2;
    border-radius:12px;
    border:none;
    font-size:1.1em;
    font-weight:700;
    margin-top:18px;
    cursor:pointer;
    transition:all .3s ease;
}
.submit-btn:hover {
    background:#9c27b0;
}
.numeric-keypad {
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    margin-bottom:10px;
}
.numeric-keypad button {
    flex:1 0 22%;
    padding:12px;
    font-size:1.1em;
    border-radius:6px;
    border:1px solid #ccc;
    background:#f0f0ff;
    cursor:pointer;
}
.numeric-keypad button:active {
    background:#d0d0ff;
}
#successTick {
    display:none;
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    font-size:80px;
    color:#16a34a;
    z-index:9999;
    animation: tickPop 0.6s ease forwards;
}
@keyframes tickPop {
    0% {transform:scale(0);}
    50% {transform:scale(1.2);}
    100% {transform:scale(1);}
}
@media(max-width:520px){
    .container{max-width:97vw;padding:10px;border-radius:12px;}
    #video{min-height:80px;}
    .voice-btn{width:45px;height:45px;font-size:24px;}
}
</style>
</head>
<body>
<div class="container" id="formContainer">
<h2>Farmer Subsidy Application</h2>
<div class="subtitle">Voice + Camera + Numeric Input. Tamil & English prompts included.</div>
<div id="progressBar"><span></span></div>
<form id="form" autocomplete="off">

<!-- Name -->
<div class="field-row">
<div style="flex:1;">
<label class="field-label" for="name"><span class="icon">person</span>Name</label>
<input id="name" placeholder="Enter Name">
</div>
<button type="button" class="voice-btn" id="voiceName"><span class="icon">mic</span></button>
</div>

<!-- Farm Location -->
<div class="field-row">
<div style="flex:1;">
<label class="field-label" for="location"><span class="icon">location_on</span>Farm Location</label>
<input id="location" placeholder="Enter Location">
</div>
<button type="button" class="voice-btn" id="voiceLocation"><span class="icon">mic</span></button>
</div>

<!-- Subsidy Type -->
<div class="field-row">
<div style="flex:1;">
<label class="field-label" for="subsidyType"><span class="icon">agriculture</span>Subsidy Type</label>
<select id="subsidyType">
<option value="">-- Select Subsidy --</option>
<option value="urimam">Urimam</option>
<option value="parivu">Parivu</option>
<option value="vidhai">Vidhai</option>
<option value="ubagaranam">Ubagaranam</option>
</select>
</div>
<button type="button" class="voice-btn" id="voiceSubsidy"><span class="icon">mic</span></button>
</div>

<!-- Amount -->
<div class="field-row">
<div style="flex:1;">
<label class="field-label" for="amount"><span class="icon">payments</span>Amount</label>
<input id="amount" placeholder="Enter Amount">
<div class="numeric-keypad" id="numericKeypad"></div>
</div>
<button type="button" class="voice-btn" id="voiceAmount"><span class="icon">mic</span></button>
</div>

<!-- Aadhaar -->
<div class="field-row">
<div style="flex:1;">
<label class="field-label" for="aadhaarNumber"><span class="icon">credit_card</span>Aadhaar Number</label>
<input id="aadhaarNumber" placeholder="XXXX XXXX XXXX" maxlength="14" readonly>
<div class="numeric-keypad" id="aadhaarKeypad"></div>
</div>
</div>

<!-- Camera -->
<video id="video" autoplay muted playsinline></video>

<button type="submit" class="submit-btn">Submit Form</button>
</form>
<div id="successTick">✔</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
<script>
const form = document.getElementById('form');
const nameInput = document.getElementById('name');
const locationInput = document.getElementById('location');
const subsidyType = document.getElementById('subsidyType');
const amountInput = document.getElementById('amount');
const aadhaarInput = document.getElementById('aadhaarNumber');

const voiceName = document.getElementById('voiceName');
const voiceLocation = document.getElementById('voiceLocation');
const voiceSubsidy = document.getElementById('voiceSubsidy');
const voiceAmount = document.getElementById('voiceAmount');

const numericKeypad = document.getElementById('numericKeypad');
const aadhaarKeypad = document.getElementById('aadhaarKeypad');
const progressBar = document.querySelector('#progressBar span');
const video = document.getElementById('video');
const successTick = document.getElementById('successTick');

const tamilVoices = {
    name: 'name.mp3',
    location: 'farmlocation.mp3',
    subsidy: 'type.mp3',
    amount: 'amount.mp3',
    afterAadhaar: 'after-aadhaar.mp3'
};

const englishTTS = {
    name: 'The name entered is ',
    location: 'The farm location is ',
    subsidy: 'Subsidy type chosen is ',
    amount: 'Amount entered is ',
    afterAadhaar: 'Details have been fetched from the bank account linked to this Aadhaar number'
};

// Initialize Tesseract OCR safely
let tesseractWorker;
async function initOCR() {
    tesseractWorker = Tesseract.createWorker({
        logger: m => console.log(m)
    });
    await tesseractWorker.load();
    await tesseractWorker.loadLanguage('eng');
    await tesseractWorker.initialize('eng');
    console.log('✅ Tesseract loaded safely.');
}
initOCR();

// Camera access
navigator.mediaDevices.getUserMedia({video:true})
.then(stream=>video.srcObject=stream)
.catch(err=>console.error('Camera error:',err));

// Utility to play audio files
function playAudio(src){
    return new Promise((resolve)=>{
        const audio = new Audio(src);
        audio.onended = resolve;
        audio.play().catch(console.error);
    });
}

// Utility to speak English TTS
function speakEnglish(text){
    return new Promise(resolve=>{
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'en-US';
        utter.onend = resolve;
        speechSynthesis.speak(utter);
    });
}

// Glow mic button while listening
async function startVoiceRecognition(inputElement, micButton, tamilFile, englishText){
    micButton.classList.add('glow');

    await playAudio(tamilFile); // Play Tamil voice first
    await speakEnglish(englishText); // Then English

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = e=>{
        const text = e.results[0][0].transcript;
        inputElement.value = text;
    };
    recognition.onend = ()=>micButton.classList.remove('glow');
    recognition.start();
}

// Attach voice events
voiceName.onclick = ()=>startVoiceRecognition(nameInput, voiceName, tamilVoices.name, englishTTS.name);
voiceLocation.onclick = ()=>startVoiceRecognition(locationInput, voiceLocation, tamilVoices.location, englishTTS.location);
voiceAmount.onclick = ()=>startVoiceRecognition(amountInput, voiceAmount, tamilVoices.amount, englishTTS.amount);

// Subsidy type voice: reads options and recognizes speech
voiceSubsidy.onclick = async ()=>{
    const micButton = voiceSubsidy;
    micButton.classList.add('glow');
    await playAudio(tamilVoices.subsidy); // Play Tamil options first
    await speakEnglish(englishTTS.subsidy); // Then English TTS

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = e=>{
        let text = e.results[0][0].transcript.toLowerCase();
        let chosen = '';
        if(text.includes('urimam')) chosen='urimam';
        else if(text.includes('parivu')) chosen='parivu';
        else if(text.includes('vidhai')) chosen='vidhai';
        else if(text.includes('ubagaranam')) chosen='ubagaranam';
        subsidyType.value=chosen;
        // Repeat English TTS for confirmation
        speakEnglish("You selected",{chosen});
    };
    recognition.onend = ()=>micButton.classList.remove('glow');
    recognition.start();
};

// Aadhaar keypad logic with spacing
function appendAadhaar(d){
    let val = aadhaarInput.value.replace(/\s/g,'');
    if(val.length>=12) return;
    val+=d;
    aadhaarInput.value = val.replace(/(\d{4})(?=\d)/g,'$1 ');
    if(val.length>=12){
        playAudio(tamilVoices.afterAadhaar).then(()=>speakEnglish(englishTTS.afterAadhaar));
    }
}

// Numeric keypad for amount
function appendAmount(d){
    amountInput.value+=d;
}

// Render Aadhaar keypad
['1','2','3','4','5','6','7','8','9','0','←'].forEach(k=>{
    const btn = document.createElement('button');
    btn.textContent=k;
    btn.onclick=()=>{
        if(k==='←'){
            let val=aadhaarInput.value.replace(/\s/g,'');
            val=val.slice(0,-1);
            aadhaarInput.value=val.replace(/(\d{4})(?=\d)/g,'$1 ');
        }else appendAadhaar(k);
    };
    aadhaarKeypad.appendChild(btn);
});

// Render amount keypad
['1','2','3','4','5','6','7','8','9','0','←'].forEach(k=>{
    const btn = document.createElement('button');
    btn.textContent=k;
    btn.onclick=()=>{
        if(k==='←') amountInput.value = amountInput.value.slice(0,-1);
        else appendAmount(k);
    };
    numericKeypad.appendChild(btn);
});

// Submit form with tick & confirmation
form.onsubmit=async e=>{
    e.preventDefault();
    // Animate form bigger
    const container=document.getElementById('formContainer');
    container.style.transform='scale(1.05)';
    container.style.transition='transform 0.3s ease';
    await new Promise(r=>setTimeout(r,350));

    successTick.style.display='block';
    setTimeout(()=>{
        successTick.style.display='none';
        container.style.transform='scale(1)';
        form.reset();
        aadhaarInput.value='';
        subsidyType.value='';
    },1000);
};
</script>
