<!-- ===== PART 1: Structure, Styles, and Basic JS Setup ===== -->
<script>
/* ===== DOM elements ===== */
const aadhaarInput = document.getElementById('aadhaarNumber');
const nameInput = document.getElementById('name');
const locationInput = document.getElementById('location');
const amountInput = document.getElementById('amount');
const subsidyOptions = document.getElementById('subsidyOptions');
const confirmList = document.getElementById('confirmList');
const confirmationBox = document.getElementById('confirmationBox');
const confirmTick = document.getElementById('confirmTick');
const submitBtn = document.getElementById('submitBtn');

const voiceNameBtn = document.getElementById('voiceName');
const voiceLocationBtn = document.getElementById('voiceLocation');
const voiceSubsidyBtn = document.getElementById('voiceSubsidy');
const voiceAmountBtn = document.getElementById('voiceAmount');

let subsidySelectedValue = '';
let aadhaarComplete = false;

/* ===== Aadhaar keypad logic ===== */
const keypadContainer = document.getElementById('aadhaarKeypad');
for(let i=1;i<=9;i++){
  const b=document.createElement('button'); b.innerText=i;
  b.onclick = ()=>appendAadhaarDigit(i);
  keypadContainer.appendChild(b);
}
const b0=document.createElement('button'); b0.innerText='0'; b0.onclick=()=>appendAadhaarDigit(0); keypadContainer.appendChild(b0);
const bDel=document.createElement('button'); bDel.innerText='⌫'; bDel.onclick=()=>removeAadhaarDigit(); keypadContainer.appendChild(bDel);

function appendAadhaarDigit(d){
  let val=aadhaarInput.value.replace(/\D/g,'');
  if(val.length>=12) return;
  val+=d;
  aadhaarInput.value=val.replace(/(\d{4})(?=\d)/g,'$1 ');
  aadhaarComplete=(val.length===12);
  updateSubmitState();
  highlightIncompleteAadhaar();
}
function removeAadhaarDigit(){
  let val=aadhaarInput.value.replace(/\D/g,'');
  val=val.slice(0,-1);
  aadhaarInput.value=val.replace(/(\d{4})(?=\d)/g,'$1 ');
  aadhaarComplete=(val.length===12);
  updateSubmitState();
  highlightIncompleteAadhaar();
}

/* ===== Highlight incomplete Aadhaar ===== */
function highlightIncompleteAadhaar(){
  if(!aadhaarComplete){
    aadhaarInput.style.borderColor = '#f87171';
  } else {
    aadhaarInput.style.borderColor = '#34d399';
  }
}

/* ===== Update submit button & progress ===== */
function updateSubmitState(){
  let filled=0,total=5;
  if(aadhaarComplete) filled++;
  if(nameInput.value.trim()) filled++;
  if(locationInput.value.trim()) filled++;
  if(amountInput.value.trim()) filled++;
  if(subsidySelectedValue) filled++;
  submitBtn.disabled=(filled<5);
  const progress = document.querySelector('#progressBar span');
  if(progress) progress.style.width=(filled/total*100)+'%';
}

/* ===== Dummy OCR simulation for camera ===== */
navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{
  const video = document.getElementById('video');
  if(video) video.srcObject = stream;
});

/* ===== Tamil Audio URLs (replace with your own links) ===== */
const tamilAudioFiles = {
  name:'https://drive.google.com/uc?export=download&id=1SrOuGA2r2IFrvLN1gKG9Jbv6vB_SLPN0',
  location:'https://drive.google.com/uc?export=download&id=1pGKF-BnqdbjtZprM-ZRMJV7rQ_oP1NSv',
  amount:'https://drive.google.com/uc?export=download&id=1XyExampleAmountLink',
  subsidy:'https://drive.google.com/uc?export=download&id=1XyExampleSubsidyLink'
};

/* ===== Play Tamil → English TTS ===== */
function playTamilThenEnglish(tamilUrl, englishText){
  return new Promise(res=>{
    const audio=new Audio(tamilUrl);
    audio.onended=()=>{ 
      const u=new SpeechSynthesisUtterance(englishText); 
      u.lang='en-IN'; u.rate=1; u.onend=res; 
      speechSynthesis.speak(u);
    };
    audio.play();
  });
}

/* ===== Voice recognition (single shot) ===== */
function startRecognitionOnce({onResult,onEnd}){
  if(!('webkitSpeechRecognition' in window)) { alert('Voice recognition unsupported'); return; }
  const rec=new webkitSpeechRecognition(); 
  rec.lang='en-IN'; rec.interimResults=false; rec.maxAlternatives=1;
  rec.onresult=e=>onResult && onResult(e.results[0][0].transcript);
  rec.onerror=()=>onEnd && onEnd();
  rec.onend=()=>onEnd && onEnd();
  rec.start();
}

/* ===== Normalize subsidy text ===== */
function normalizeSubsidyText(txt){
  txt=txt.toLowerCase();
  if(txt.includes('urimam')) return 'urimam';
  if(txt.includes('parivu')) return 'parivu';
  if(txt.includes('vidhai')) return 'vidhai';
  if(txt.includes('ubagaranam')) return 'ubagaranam';
  return '';
}

/* ===== Voice flow with soft aura ===== */
async function voiceFlow({tamilUrl,englishPrompt,onResult,btn}){
  btn.classList.add('listening','soft-aura');
  await playTamilThenEnglish(tamilUrl,englishPrompt);
  startRecognitionOnce({
    onResult:(txt)=>{
      btn.classList.remove('listening','soft-aura');
      onResult && onResult(txt||'');
      updateSubmitState();
    },
    onEnd:()=>btn.classList.remove('listening','soft-aura')
  });
}

/* ===== Wire voice buttons (Part 1) ===== */
voiceNameBtn.onclick=()=>voiceFlow({
  tamilUrl:tamilAudioFiles.name,
  englishPrompt:'Please say your name now.',
  onResult:t=>{nameInput.value=t;},
  btn:voiceNameBtn
});

voiceLocationBtn.onclick=()=>voiceFlow({
  tamilUrl:tamilAudioFiles.location,
  englishPrompt:'Please say farm location.',
  onResult:t=>{locationInput.value=t;},
  btn:voiceLocationBtn
});

voiceAmountBtn.onclick=()=>voiceFlow({
  tamilUrl:tamilAudioFiles.amount,
  englishPrompt:'Please say amount.',
  onResult:t=>{amountInput.value=t.replace(/\D/g,'');},
  btn:voiceAmountBtn
});

/* ===== Input listeners for manual typing ===== */
[nameInput,locationInput,amountInput].forEach(inp=>inp.addEventListener('input',updateSubmitState));
updateSubmitState();
</script>
<!-- ===== PART 2: Subsidy Voice, Click, TTS, and Submit Flow ===== -->
<script>
/* ===== Subsidy click & TTS confirmation ===== */
subsidyOptions.addEventListener('click', ev=>{
  const box = ev.target.closest('.subsidy-box');
  if(!box) return;
  document.querySelectorAll('.subsidy-box').forEach(b=>b.classList.remove('selected'));
  box.classList.add('selected');
  subsidySelectedValue = box.dataset.value;

  // Speak confirmation
  const label = box.innerText.trim();
  const u = new SpeechSynthesisUtterance("You selected",{label});
  u.lang = 'en-IN';
  u.rate = 1;
  speechSynthesis.speak(u);

  updateSubmitState();
});

/* ===== Subsidy voice button ===== */
voiceSubsidyBtn.onclick = ()=>voiceFlow({
  tamilUrl: tamilAudioFiles.subsidy,
  englishPrompt: 'Please say subsidy type: Urimam, Parivu, Vidhai, or Ubagaranam.',
  onResult: raw=>{
    const normalized = normalizeSubsidyText(raw);
    if(normalized){
      subsidySelectedValue = normalized;
      document.querySelectorAll('.subsidy-box').forEach(b=>b.classList.remove('selected'));
      const found = document.querySelector(subsidy-box[data_value = {normalized}]);
      if(found) found.classList.add('selected');

      // Speak confirmation
      const label = found.innerText.trim();
      const u = new SpeechSynthesisUtterance("You selected",label);
      u.lang = 'en-IN'; u.rate = 1;
      speechSynthesis.speak(u);
    }
    updateSubmitState();
  },
  btn: voiceSubsidyBtn
});

/* ===== Submit flow ===== */
document.getElementById('form').addEventListener('submit', async e=>{
  e.preventDefault();

  if(aadhaarInput.value.replace(/\s/g,'').length !== 12){
    alert('Complete 12-digit Aadhaar');
    return;
  }
  if(!nameInput.value.trim() || !locationInput.value.trim() || !amountInput.value.trim() || !subsidySelectedValue){
    alert('Please fill all fields');
    return;
  }

  // Show confirmation list
  confirmList.innerHTML = `
    <div><strong>Aadhaar:</strong> ${aadhaarInput.value}</div>
    <div><strong>Name:</strong> ${nameInput.value}</div>
    <div><strong>Location:</strong> ${locationInput.value}</div>
    <div><strong>Amount:</strong> ${amountInput.value}</div>
    <div><strong>Subsidy:</strong> ${subsidySelectedValue}</div>
  `;

  // Show confirmation box with animation
  confirmationBox.style.display = 'block';
  confirmationBox.style.transform = 'translate(-50%,-50%) scale(1)';
  confirmationBox.setAttribute('aria-hidden', 'false');

  // Speak success message
  await new Promise(res=>{
    const u = new SpeechSynthesisUtterance('Form submitted successfully');
    u.lang = 'en-IN'; u.rate = 1; u.onend = res;
    speechSynthesis.speak(u);
  });

  // Show green tick
  confirmTick.style.display = 'block';

  // Hide confirmation & reset after 2s
  setTimeout(()=>{
    confirmationBox.style.display = 'none';
    confirmationBox.setAttribute('aria-hidden', 'true');
    confirmTick.style.display = 'none';

    // Reset form
    document.getElementById('form').reset();
    aadhaarInput.value = '';
    nameInput.value = '';
    locationInput.value = '';
    amountInput.value = '';
    subsidySelectedValue = '';
    aadhaarComplete = false;
    document.querySelectorAll('.subsidy-box').forEach(b=>b.classList.remove('selected'));
    updateSubmitState();
  }, 2000);
});

/* ===== Add soft aura effect on voice buttons ===== */
const voiceButtons = [voiceNameBtn, voiceLocationBtn, voiceAmountBtn, voiceSubsidyBtn];
voiceButtons.forEach(btn=>{
  btn.addEventListener('mousedown', ()=> btn.classList.add('listening','soft-aura'));
  btn.addEventListener('mouseup', ()=> btn.classList.remove('listening','soft-aura'));
  btn.addEventListener('mouseleave', ()=> btn.classList.remove('listening','soft-aura'));
});
</script>
